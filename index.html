<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Try-On Widget</title>
    <style>

/* Custom Notification Styles */
.custom-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3), 0 0 0 1px rgba(255,255,255,0.1);
    z-index: 50000;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    font-size: 14px;
    max-width: 350px;
    transform: translateY(-100px) scale(0.8);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
}

.custom-notification.show {
    transform: translateY(0) scale(1);
    opacity: 1;
}

.custom-notification.hide {
    transform: translateY(-50px) scale(0.9);
    opacity: 0;
}

.notification-icon {
    width: 24px;
    height: 24px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
    animation: successPulse 0.6s ease;
}

.notification-content {
    flex: 1;
    line-height: 1.4;
}

.notification-title {
    font-weight: 700;
    margin-bottom: 2px;
    font-size: 15px;
}

.notification-subtitle {
    opacity: 0.9;
    font-size: 13px;
    font-weight: 500;
}

.notification-close {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
    transition: all 0.2s ease;
    font-size: 16px;
    flex-shrink: 0;
}

.notification-close:hover {
    opacity: 1;
    background: rgba(255,255,255,0.1);
}

@keyframes successPulse {
    0% {
        transform: scale(0);
        background: rgba(255,255,255,0.4);
    }
    50% {
        transform: scale(1.2);
        background: rgba(255,255,255,0.3);
    }
    100% {
        transform: scale(1);
        background: rgba(255,255,255,0.2);
    }
}

/* Mobile responsive */
@media (max-width: 768px) {
    .custom-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
        transform: translateY(-100px) scale(0.9);
    }
}

/* Progress bar for auto-dismiss */
.notification-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: rgba(255,255,255,0.3);
    border-radius: 0 0 12px 12px;
    width: 100%;
    transform-origin: left;
    animation: progressShrink 4s linear;
}

@keyframes progressShrink {
    from { transform: scaleX(1); }
    to { transform: scaleX(0); }
}

       /* Reset and base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.4;
}

/* Mobile detection and responsive styles */
.is-mobile {
    /* Mobile-specific styles will be applied via JavaScript */
}

/* Widget Container - Clean White Style */
.virtual-tryon-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 420px;
    height: 650px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%);
    border-radius: 8px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.1);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(20px);
    border: 1px solid #e0e0e0;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .virtual-tryon-widget {
        bottom: 10px;
        right: 10px;
        left: 10px;
        width: calc(100vw - 20px);
        height: calc(100vh - 20px);
        max-height: 750px;
        border-radius: 6px;
    }

    .virtual-tryon-widget.widget-minimized {
        bottom: 20px !important;
        right: 20px !important;
        left: auto !important;
        width: 64px !important;
        height: 64px !important;
    }
}

@media (max-width: 480px) {
    .virtual-tryon-widget {
        bottom: 5px;
        right: 5px;
        left: 5px;
        width: calc(100vw - 10px);
        height: calc(100vh - 10px);
        max-height: none;
        border-radius: 6px;
    }
}

.widget-minimized {
    width: 72px !important;
    height: 72px !important;
    border-radius: 8px !important;
    cursor: pointer;
    background: linear-gradient(135deg, #f0f0f0 0%, #ffffff 50%, #f8f8f8 100%);
    display: flex !important;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    overflow: hidden !important;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    animation: subtleGlow 4s ease-in-out infinite;
    border: 1px solid #d0d0d0;
}

@keyframes subtleGlow {
    0%, 100% { 
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0,0,0,0.1);
        transform: translateY(0);
    }
    50% { 
        box-shadow: 0 16px 50px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
}

.widget-minimized .widget-header,
.widget-minimized .mode-selector,
.widget-minimized .widget-content,
.widget-minimized .input-area {
    display: none !important;
}

.widget-minimized::after {
    content: '⚡\ATRY';
    display: block;
    color: #333;
    font-size: 10px;
    font-weight: 700;
    text-align: center;
    line-height: 1.1;
    letter-spacing: 1px;
    white-space: pre-line;
    text-transform: uppercase;
    text-shadow: 0 2px 4px rgba(255,255,255,0.8);
}

/* Header - Clean White */
.widget-header {
    background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 50%, #f0f0f0 100%);
    color: #333;
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    border-bottom: 1px solid #e0e0e0;
}

.widget-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M0,10 Q25,0 50,10 T100,10 V20 H0 Z" fill="rgba(0,0,0,0.05)"/></svg>') no-repeat bottom;
    background-size: 100% 20px;
}

.widget-title {
    font-size: 18px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #333;
}

.widget-toggle {
    background: rgba(0,0,0,0.1);
    border: 1px solid #ccc;
    color: #333;
    font-size: 16px;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
    -webkit-tap-highlight-color: transparent;
}

.widget-toggle:hover {
    background: rgba(0,0,0,0.2);
    border-color: #999;
}

/* Mode Selector - Light */
.mode-selector {
    display: flex;
    background: #f8f8f8;
    margin: 0;
    position: relative;
    border-bottom: 1px solid #e0e0e0;
}

.mode-btn {
    flex: 1;
    padding: 14px;
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 13px;
    color: #666;
    position: relative;
    text-transform: uppercase;
    letter-spacing: 1px;
    -webkit-tap-highlight-color: transparent;
}

.mode-btn.active {
    background: #ffffff;
    color: #333;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.mode-btn.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 2px;
    background: #333;
    border-radius: 0;
}

/* Content Area - Light Theme */
.widget-content {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #ffffff;
}

.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    -webkit-overflow-scrolling: touch;
}

.message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.5;
    animation: messageSlideIn 0.4s ease;
}

.user-message {
    background: #f0f0f0;
    color: #333;
    align-self: flex-end;
    border-bottom-right-radius: 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
}

.bot-message {
    background: #f8f8f8;
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid #e0e0e0;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(15px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Try-On Content */
.tryon-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

/* Featured Section - Light Style */
.featured-section {
    padding: 20px;
    background: #ffffff;
    border-bottom: 1px solid #e0e0e0;
}

/* Mobile-specific featured section adjustments */
@media (max-width: 768px) {
    .featured-section {
        padding: 16px;
    }
}

.section-title {
    font-size: 16px;
    font-weight: 700;
    color: #333;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Mobile-specific section title adjustments */
@media (max-width: 768px) {
    .section-title {
        font-size: 14px;
        margin-bottom: 12px;
    }
}

.featured-item {
    background: #f8f8f8;
    border-radius: 6px;
    padding: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

/* Mobile-specific featured item adjustments */
@media (max-width: 768px) {
    .featured-item {
        padding: 14px;
        border-radius: 6px;
    }
}

.featured-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #333, #666);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.featured-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    border-color: #ccc;
}

.featured-item:hover::before {
    transform: scaleX(1);
}

.featured-item.selected {
    border-color: #333;
    background: #f0f0f0;
    transform: translateY(-2px);
}

.featured-item.selected::before {
    transform: scaleX(1);
}

.featured-content {
    display: flex;
    gap: 16px;
    align-items: center;
}

/* Mobile-specific featured content adjustments */
@media (max-width: 768px) {
    .featured-content {
        gap: 12px;
    }
}

.featured-image {
    width: 70px;
    height: 70px;
    border-radius: 4px;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
}

/* Mobile-specific featured image adjustments */
@media (max-width: 768px) {
    .featured-image {
        width: 60px;
        height: 60px;
        border-radius: 4px;
    }
}

.featured-info {
    flex: 1;
}

.featured-name {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Mobile-specific featured name adjustments */
@media (max-width: 768px) {
    .featured-name {
        font-size: 13px;
    }
}

.featured-price {
    font-size: 16px;
    font-weight: 700;
    color: #333;
    margin-bottom: 6px;
}

/* Mobile-specific featured price adjustments */
@media (max-width: 768px) {
    .featured-price {
        font-size: 15px;
        margin-bottom: 4px;
    }
}

.featured-badge {
    display: inline-block;
    background: #e0e0e0;
    color: #333;
    padding: 2px 8px;
    border-radius: 2px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid #ccc;
}

/* Mobile-specific featured badge adjustments */
@media (max-width: 768px) {
    .featured-badge {
        padding: 2px 6px;
        font-size: 9px;
    }
}

/* Quick Picks Section */
.quick-picks-section {
    padding: 20px;
    background: #ffffff;
}

/* Mobile-specific quick picks section adjustments */
@media (max-width: 768px) {
    .quick-picks-section {
        padding: 16px;
    }
}

.quick-picks-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

/* Force exactly 2 columns on mobile - all mobile devices */
@media (max-width: 768px) {
    .quick-picks-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px;
        margin-bottom: 16px;
        width: 100%;
    }
}

/* Force exactly 2 columns on small mobile devices */
@media (max-width: 480px) {
    .quick-picks-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 8px;
        width: 100%;
    }
}

/* Force exactly 2 columns on very small screens */
@media (max-width: 320px) {
    .quick-picks-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 6px;
        width: 100%;
    }
}

.quick-pick-item {
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    overflow: hidden;
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    width: 100%;
}

/* Mobile-specific quick pick item adjustments */
@media (max-width: 768px) {
    .quick-pick-item {
        padding: 14px 10px;
        border-radius: 6px;
        min-height: auto;
        max-width: none;
        width: 100%;
        display: flex;
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .quick-pick-item {
        padding: 10px 6px;
        min-height: auto;
        width: 100%;
    }
}

@media (max-width: 320px) {
    .quick-pick-item {
        padding: 8px 4px;
        min-height: auto;
        width: 100%;
    }
}

.quick-pick-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.02));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.quick-pick-item:hover {
    border-color: #ccc;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.quick-pick-item:hover::before {
    opacity: 1;
}

.quick-pick-item.selected {
    border-color: #333;
    background: #f0f0f0;
    transform: translateY(-2px);
}

.quick-pick-image {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
    flex-shrink: 0;
    border: 1px solid #ddd;
}

/* Mobile-specific image adjustments for perfect display without cut-off */
@media (max-width: 768px) {
    .quick-pick-image {
        height: auto;
        min-height: 100px;
        max-height: 140px;
        margin-bottom: 8px;
        border-radius: 4px;
        object-fit: contain;
        object-position: center;
        background-color: #f0f0f0;
        width: 100%;
    }
}

@media (max-width: 480px) {
    .quick-pick-image {
        height: auto;
        min-height: 80px;
        max-height: 120px;
        margin-bottom: 6px;
        object-fit: contain;
        object-position: center;
        background-color: #f0f0f0;
    }
}

@media (max-width: 320px) {
    .quick-pick-image {
        height: auto;
        min-height: 70px;
        max-height: 100px;
        margin-bottom: 5px;
        object-fit: contain;
        object-position: center;
        background-color: #f0f0f0;
    }
}

.quick-pick-name {
    font-size: 11px;
    font-weight: 600;
    color: #333;
    margin-bottom: 6px;
    position: relative;
    z-index: 1;
    line-height: 1.3;
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 32px;
}

/* Mobile-specific name adjustments */
@media (max-width: 768px) {
    .quick-pick-name {
        font-size: 10px;
        margin-bottom: 3px;
        line-height: 1.2;
    }
}

@media (max-width: 480px) {
    .quick-pick-name {
        font-size: 9px;
    }
}

.quick-pick-price {
    font-size: 13px;
    font-weight: 700;
    color: #333;
    position: relative;
    z-index: 1;
    flex-shrink: 0;
    margin-top: auto;
    padding-top: 4px;
}

/* Mobile-specific price adjustments */
@media (max-width: 768px) {
    .quick-pick-price {
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .quick-pick-price {
        font-size: 11px;
    }
}

/* Photo Upload Section */
.photo-section {
    padding: 20px;
    background: #f8f8f8;
    border-top: 1px solid #e0e0e0;
}

/* Mobile-specific photo section adjustments */
@media (max-width: 768px) {
    .photo-section {
        padding: 16px;
    }
}

.photo-instruction {
    text-align: center;
    margin-bottom: 12px;
    color: #666;
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Mobile-specific instruction adjustments */
@media (max-width: 768px) {
    .photo-instruction {
        font-size: 12px;
        margin-bottom: 10px;
    }
}

.photo-upload {
    border: 2px dashed #ccc;
    border-radius: 6px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #ffffff;
    position: relative;
    overflow: hidden;
}

/* Mobile-specific photo upload adjustments */
@media (max-width: 768px) {
    .photo-upload {
        padding: 16px;
        border-radius: 6px;
    }
}

.photo-upload::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.01));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.photo-upload:hover {
    border-color: #999;
    background: #f8f8f8;
}

.photo-upload:hover::before {
    opacity: 1;
}

.photo-upload.has-photo {
    padding: 12px;
    border-style: solid;
    border-color: #999;
    background: #f8f8f8;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;
}

/* Mobile-specific photo upload container adjustments */
@media (max-width: 768px) {
    .photo-upload.has-photo {
        min-height: 120px;
        padding: 10px;
    }
}

@media (max-width: 768px) {
    .photo-upload {
        display: none;
    }
    
    .photo-upload.has-photo {
        display: block !important;
    }
}

.upload-icon {
    font-size: 32px;
    margin-bottom: 8px;
    opacity: 0.6;
    position: relative;
    z-index: 1;
    color: #666;
}

.upload-text {
    color: #666;
    font-size: 13px;
    font-weight: 500;
    position: relative;
    z-index: 1;
}

.photo-preview {
    max-width: 100%;
    max-height: 80px;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: block;
    margin: 0 auto;
    object-fit: contain;
    width: auto;
    height: auto;
    border: 1px solid #ddd;
}

/* Mobile-specific photo preview adjustments */
@media (max-width: 768px) {
    .photo-preview {
        max-height: 100px;
        max-width: 100%;
        object-fit: contain;
        width: auto;
        height: auto;
    }
}

/* Camera Controls */
.camera-controls {
    display: none;
    flex-direction: row;
    gap: 10px;
    margin: 12px 0;
}

.camera-controls.mobile {
    display: flex;
}

@media (max-width: 768px) {
    .camera-controls {
        gap: 8px;
        margin: 10px 0;
    }
}

@media (hover: hover) and (pointer: fine) {
    .camera-controls {
        display: none !important;
    }
}

.camera-option-btn {
    flex: 1;
    background: linear-gradient(135deg, #f0f0f0 0%, #ffffff 100%);
    border: 1px solid #ccc;
    color: #333;
    padding: 12px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    -webkit-tap-highlight-color: transparent;
}

/* Mobile-specific camera button adjustments */
@media (max-width: 768px) {
    .camera-option-btn {
        padding: 10px 12px;
        font-size: 11px;
        border-radius: 6px;
    }
}

.camera-option-btn:hover {
    background: linear-gradient(135deg, #e0e0e0 0%, #f0f0f0 100%);
    border-color: #999;
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 12px;
    padding: 20px;
    background: #ffffff;
    border-top: 1px solid #e0e0e0;
}

/* Mobile-specific action buttons adjustments */
@media (max-width: 768px) {
    .action-buttons {
        padding: 16px;
        gap: 10px;
    }
}

.btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    -webkit-tap-highlight-color: transparent;
}

/* Mobile-specific button adjustments */
@media (max-width: 768px) {
    .btn {
        padding: 12px;
        font-size: 12px;
        border-radius: 6px;
    }
}

.btn-primary {
    background: linear-gradient(135deg, #333 0%, #555 100%);
    color: #fff;
    border: 1px solid #333;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #222 0%, #444 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}



.btn-secondary {
    background: #f0f0f0;
    color: #666;
    border: 1px solid #e0e0e0;
}

.btn-secondary:hover {
    background: #e0e0e0;
    border-color: #ccc;
    color: #333;
    transform: translateY(-1px);
}

/* Browse All Button */
.browse-all-btn {
    width: 100%;
    background: #f0f0f0;
    border: 1px solid #e0e0e0;
    color: #666;
    padding: 14px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 13px;
}

/* Mobile-specific browse button adjustments */
@media (max-width: 768px) {
    .browse-all-btn {
        padding: 12px;
        font-size: 12px;
        border-radius: 6px;
    }
}

.browse-all-btn:hover {
    background: #e0e0e0;
    border-color: #ccc;
    color: #333;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

/* Input Area */
.input-area {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    background: #ffffff;
    display: none;
}

/* Mobile-specific input area adjustments */
@media (max-width: 768px) {
    .input-area {
        padding: 16px;
    }
}

.input-area.chat-mode {
    display: block !important;
}

.input-container {
    display: flex;
    gap: 12px;
    align-items: center;
}

.message-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    outline: none;
    font-size: 14px;
    transition: all 0.3s ease;
    background: #f8f8f8;
    color: #333;
}

.message-input:focus {
    border-color: #ccc;
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
}

.message-input::placeholder {
    color: #999;
}

.send-btn {
    background: linear-gradient(135deg, #f0f0f0, #ffffff);
    border: 1px solid #ccc;
    color: #333;
    width: 40px;
    height: 40px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.send-btn:hover {
    background: linear-gradient(135deg, #e0e0e0, #f0f0f0);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* Result Section */
.result-container {
    text-align: center;
    padding: 20px;
    background: #ffffff;
    border-top: 1px solid #e0e0e0;
}

.result-container h4 {
    color: #333;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 14px;
}

.result-container p {
    color: #666;
    margin: 12px 0;
    font-size: 13px;
}

.result-image {
    max-width: 100%;
    max-height: 280px;
    border-radius: 6px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.3s ease;
    object-fit: contain;
    width: auto;
    height: auto;
    display: block;
    margin: 0 auto;
    border: 1px solid #e0e0e0;
}

.result-image:hover {
    transform: scale(1.02);
}

/* Mobile-specific result image adjustments */
@media (max-width: 768px) {
    .result-image {
        max-height: 250px;
        max-width: 100%;
        object-fit: contain;
        width: auto;
        height: auto;
    }
}

@media (max-width: 480px) {
    .result-image {
        max-height: 200px;
        max-width: 100%;
        object-fit: contain;
        width: auto;
        height: auto;
    }
}

/* Buy Now Button */
.buy-now-container {
    margin-top: 16px;
}

.buy-now-btn {
    background: linear-gradient(135deg, #333 0%, #555 100%);
    color: #fff;
    border: 1px solid #333;
    padding: 14px 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.buy-now-btn:hover {
    background: linear-gradient(135deg, #222 0%, #444 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.buy-now-btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
}

.buy-now-btn .loading-spinner {
    display: none;
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-top: 2px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
}

.buy-now-btn.loading .loading-spinner {
    display: block;
}

.buy-now-btn.loading .btn-text {
    opacity: 0.7;
}

/* Loading States */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    color: #666;
}

.spinner {
    width: 18px;
    height: 18px;
    border: 2px solid #e0e0e0;
    border-top: 2px solid #999;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 12px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Hidden Elements */
.hidden-input {
    display: none;
}

/* Modal Styles - Light Theme */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 15000;
    backdrop-filter: blur(4px);
}

.modal-backdrop.active {
    display: block;
}

.clothing-browser-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20000;
}

.clothing-browser-modal.active {
    display: flex;
}

.clothing-browser-content {
    background: #ffffff;
    width: 90vw;
    height: 90vh;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 25px 80px rgba(0,0,0,0.2);
    border: 1px solid #e0e0e0;
}

.browser-header {
    background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 50%, #e8e8e8 100%);
    color: #333;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e0e0e0;
}

@media (max-width: 480px) {
    .browser-header {
        padding: 15px;
    }
}

.browser-title {
    font-size: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

@media (max-width: 480px) {
    .browser-title {
        font-size: 16px;
    }
}

.browser-close {
    background: rgba(0,0,0,0.1);
    border: 1px solid #ccc;
    color: #333;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

@media (max-width: 480px) {
    .browser-close {
        width: 32px;
        height: 32px;
        font-size: 18px;
    }
}

.browser-close:hover {
    background: rgba(0,0,0,0.2);
}

.browser-body {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    -webkit-overflow-scrolling: touch;
}

@media (max-width: 480px) {
    .browser-body {
        padding: 15px;
    }
}

.browser-search-container {
    margin-bottom: 16px;
}

.browser-search {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
    background: #f8f8f8;
    color: #333;
    margin-bottom: 0;
    -webkit-appearance: none;
}

@media (max-width: 480px) {
    .browser-search {
        padding: 10px 14px;
        font-size: 16px; /* Prevents zoom on iOS */
    }
}

.browser-search:focus {
    border-color: #ccc;
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
}

.browser-search::placeholder {
    color: #999;
}

.browser-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
}

/* Force exactly 2 columns on mobile for clothing browser */
@media (max-width: 768px) {
    .browser-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 12px;
        padding: 0 5px;
    }
}

/* Force exactly 2 columns on smaller mobile devices */
@media (max-width: 480px) {
    .browser-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px;
        padding: 0 3px;
    }
}

/* Force exactly 2 columns on very small screens */
@media (max-width: 320px) {
    .browser-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 8px;
        padding: 0 2px;
    }
}

.browser-clothing-card {
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    -webkit-tap-highlight-color: transparent;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 100%;
    min-height: 160px;
}

/* Mobile-specific browser card adjustments - perfect 2-column layout */
@media (max-width: 768px) {
    .browser-clothing-card {
        padding: 10px 6px;
        border-radius: 6px;
        min-height: 180px;
        max-width: none;
        width: 100%;
    }
}

@media (max-width: 480px) {
    .browser-clothing-card {
        padding: 8px 4px;
        border-radius: 6px;
        min-height: 170px;
        width: 100%;
    }
}

@media (max-width: 320px) {
    .browser-clothing-card {
        padding: 6px 3px;
        border-radius: 4px;
        min-height: 160px;
        width: 100%;
    }
}

.browser-clothing-card:hover {
    border-color: #ccc;
    background: #f0f0f0;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.browser-clothing-card:active {
    transform: translateY(-1px);
}

.browser-clothing-card.selected {
    border-color: #333;
    background: #f0f0f0;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.browser-clothing-card img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 8px;
    border: 1px solid #ddd;
    flex-shrink: 0;
}

/* Mobile-specific browser image adjustments - prevent cut-off */
@media (max-width: 768px) {
    .browser-clothing-card img {
        height: 100px;
        margin-bottom: 6px;
        border-radius: 4px;
        object-fit: cover;
        width: 100%;
    }
}

@media (max-width: 480px) {
    .browser-clothing-card img {
        height: 90px;
        margin-bottom: 5px;
        border-radius: 4px;
    }
}

@media (max-width: 320px) {
    .browser-clothing-card img {
        height: 80px;
        margin-bottom: 4px;
        border-radius: 3px;
    }
}

/* Desktop fix for browser images */
@media (min-width: 769px) {
    .browser-clothing-card img {
        height: auto;
        min-height: 100px;
        max-height: 150px;
        object-fit: contain;
        object-position: center;
        background-color: #f0f0f0;
        border-radius: 4px;
        margin-bottom: 8px;
        width: 100%;
    }
    
    .browser-clothing-card {
        min-height: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
    }
}

/* Browser card text styling */
.browser-card-name {
    font-size: 12px;
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
    line-height: 1.3;
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.browser-card-price {
    font-size: 14px;
    font-weight: 700;
    color: #333;
    flex-shrink: 0;
}

/* Mobile-specific browser text adjustments */
@media (max-width: 768px) {
    .browser-card-name {
        font-size: 10px;
        margin-bottom: 3px;
        line-height: 1.2;
    }
    
    .browser-card-price {
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .browser-card-name {
        font-size: 9px;
        margin-bottom: 2px;
    }
    
    .browser-card-price {
        font-size: 11px;
    }
}

@media (max-width: 320px) {
    .browser-card-name {
        font-size: 8px;
        margin-bottom: 2px;
    }
    
    .browser-card-price {
        font-size: 10px;
    }
}

.search-results-count {
    margin-bottom: 12px;
    color: #666;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.no-results {
    text-align: center;
    padding: 40px;
    color: #999;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Image Modal */
.image-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 25000;
    backdrop-filter: blur(8px);
}

.image-modal.active {
    display: flex;
}

.modal-content {
    position: relative;
    max-width: 95vw;
    max-height: 95vh;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-image {
    max-width: 90vw;
    max-height: 85vh;
    width: auto;
    height: auto;
    border-radius: 8px;
    object-fit: contain;
    display: block;
    margin: 0 auto;
    border: 1px solid #e0e0e0;
    background: #fff;
}

/* Mobile-specific modal image adjustments */
@media (max-width: 768px) {
    .modal-image {
        max-width: 95vw;
        max-height: 90vh;
        object-fit: contain;
        width: auto;
        height: auto;
        border-radius: 6px;
    }
}

.modal-close {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #f0f0f0;
    border: 1px solid #ccc;
    color: #333;
    width: 40px;
    height: 40px;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: #e0e0e0;
    border-color: #999;
}

/* iOS Safari specific fixes */
@supports (-webkit-touch-callout: none) {
    .message-input,
    .browser-search {
        -webkit-appearance: none;
        border-radius: 6px;
    }
}

/* Prevent text selection on touch devices */
.featured-item,
.quick-pick-item,
.browser-clothing-card,
.btn,
.mode-btn,
.widget-toggle {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Ensure widget close button is always visible on mobile */
@media (max-width: 768px) {
    .widget-header {
        position: sticky;
        top: 0;
        z-index: 10001;
        background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 50%, #f0f0f0 100%);
    }
    .widget-toggle {
        z-index: 10002;
    }
}

/* Add error notification style */
.custom-notification.error {
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
    color: white;
    box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
}
.notification-icon {
    color: white;
    font-size: 16px;
}
    </style>
</head>
<body>
    <div id="virtualTryonWidget" class="virtual-tryon-widget widget-minimized">
        
        <!-- Header -->
        <div class="widget-header">
            <h3 class="widget-title">Virtual Try-On</h3>
            <button class="widget-toggle" onclick="closeWidget()" aria-label="Close virtual try-on widget">×</button>
        </div>

        <!-- Content -->
        <div class="widget-content">
            <!-- Try-On Specific Content -->
            <div id="tryonContent" class="tryon-content" style="display: block;">
                
                <!-- Featured Item Section -->
                <div class="featured-section">
                    <h4 class="section-title">
                        <span>⭐</span>
                        Featured Today
                    </h4>
                    <div id="featuredItem" class="featured-item" onclick="selectFeaturedClothing()">
                        <!-- Featured item will be populated here -->
                    </div>
                </div>

                <!-- Quick Picks Section -->
                <div class="quick-picks-section">
                    <h4 class="section-title">
                        <span>🔥</span>
                        Quick Picks
                    </h4>
                    <div id="quickPicksGrid" class="quick-picks-grid">
                        <!-- Quick pick items will be populated here -->
                    </div>
                    <button class="browse-all-btn" onclick="openClothingBrowser()">
                        <span>👗</span>
                        Browse Full Collection
                        <span>→</span>
                    </button>
                </div>

                <!-- Photo Upload Section -->
                <div class="photo-section">
                    <div class="photo-instruction">Upload full body image to get started</div>
                    
                    <div class="photo-upload" onclick="handlePhotoUploadClick()">
                        <div class="upload-icon">🧍</div>
                        <div class="upload-text">Tap to upload full body image</div>
                        <img id="photoPreview" class="photo-preview" style="display: none;">
                        <div id="changePhotoText" class="upload-text" style="display: none; margin-top: 8px; font-size: 12px; color: #6366f1;">Tap to change photo</div>
                    </div>
                    
                    <!-- Mobile Camera Controls -->
                    <div id="cameraControls" class="camera-controls">
                        <button class="camera-option-btn" onclick="takePicture()" type="button">
                            <span class="icon">📸</span>
                            <span>Camera</span>
                        </button>
                        <button class="camera-option-btn" onclick="chooseFromGallery()" type="button">
                            <span class="icon">🖼️</span>
                            <span>Gallery</span>
                        </button>
                    </div>
                    
                    <!-- File inputs -->
                    <input type="file" id="photoInput" class="hidden-input" accept="image/*" onchange="handlePhotoUpload(event)">
                    <input type="file" id="cameraInput" class="hidden-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event)">
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="closeWidget()">
                        <span>✕</span>
                        Close
                    </button>
                    <button class="btn btn-primary" onclick="startTryOn()" id="tryOnBtn" disabled aria-label="Try on selected clothing with your photo. Press Enter to activate.">
                        <span>✨</span>
                        Try On
                    </button>
                </div>
                
                <div id="resultSection" style="display: none;">
                    <!-- Result will be shown here -->
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <!-- (Removed chat input area) -->
    </div>

    <!-- Clothing Browser Modal -->
    <div id="modalBackdrop" class="modal-backdrop" onclick="closeClothingBrowser()"></div>
    <div id="clothingBrowserModal" class="clothing-browser-modal">
        <div class="clothing-browser-content">
            <div class="browser-header">
                <h2 class="browser-title">Browse Collection</h2>
                <button class="browser-close" onclick="closeClothingBrowser()">&times;</button>
            </div>
            <div class="browser-body">
                <div class="browser-search-container">
                    <input type="text" class="browser-search" id="browserSearch" placeholder="Search for clothes, colors, or categories..." oninput="handleBrowserSearch()">
                </div>
                <div id="searchResultsCount" class="search-results-count"></div>
                <div id="browserGrid" class="browser-grid">
                    <!-- Clothing items will be populated here -->
                </div>
                <div id="noResultsMessage" class="no-results" style="display: none;">
                    No items found. Try a different search term.
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal(event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeImageModal()">&times;</button>
            <img id="modalImage" class="modal-image" src="" alt="Virtual Try-On Result">
        </div>
    </div>

    <script>
        // Configuration
        const WEBHOOK_URL = 'https://ancesoftware.app.n8n.cloud/webhook-test/virtual-tryon-production';
        
        // Mobile detection
        let isMobile = false;
        let isTablet = false
        let isIOS = false;
        let isAndroid = false;

        // ============================================================================
        // CONFIGURATION & CONSTANTS
        // ============================================================================
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://rwmvgwnebnsqcyhhurti.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXZnd25lYm5zcWN5aGh1cnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDc1MTgsImV4cCI6MjA2Mzk4MzUxOH0.OYTXiUBDN5IBlFYDHN3MyCwFUkSb8sgUOewBeSY01NY';
        

        
        // Widget Configuration
        const WIDGET_CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            ALLOWED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/webp', 'image/gif'],
            MAX_MESSAGE_LENGTH: 1000,
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 1000
        };
        
        // ============================================================================
        // DATA STORAGE
        // ============================================================================
        
        // Dynamic clothing data from Supabase
        let sampleClothing = [];

// Load clothing data from active_clothing_items view
// Load clothing data from active_clothing_items table
async function loadClothingData() {
    try {
        // Get store name from window variable or default to your test store
        const storeName = window.ELLO_STORE_NAME || 'm8ir6h-8k'; // Your Shopify store name
        
        console.log('Loading products from Shopify store:', storeName);
        
        // Fetch all products from Shopify as JSON with retry logic
        const response = await fetchWithRetry(`https://${storeName}.myshopify.com/products.json?limit=250`, {
    method: 'GET'
    // No headers needed for GET request
});
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.products || !Array.isArray(data.products)) {
            throw new Error('Invalid data format received from Shopify');
        }
        
        console.log('Shopify products loaded:', data.products.length);
        
        // Convert Shopify products to your widget format with validation
        sampleClothing = data.products
            .filter(product => product && product.handle && product.title) // Validate required fields
            .map(product => {
                const firstVariant = product.variants?.[0] || {};
                const firstImage = product.images?.[0] || {};
                
                return {
                    id: product.handle, // Use Shopify handle as ID
                    name: product.title,
                    price: parseFloat(firstVariant.price || 0),
                    category: product.product_type?.toLowerCase() || 'clothing',
                    color: getColorFromProduct(product),
                    image_url: firstImage.src || '',
                    product_url: `https://${storeName}.myshopify.com/products/${product.handle}`,
                    shopify_product_id: product.id,
                    // Store all variants for size selection later
                    variants: (product.variants || []).map(variant => ({
                        id: variant.id,
                        title: variant.title,
                        price: parseFloat(variant.price || 0),
                        available: variant.available || false,
                        size: variant.option1, // Usually size
                        color: variant.option2, // Usually color  
                        option3: variant.option3
                    }))
                };
            });
        
        console.log(`✅ Loaded ${sampleClothing.length} products from Shopify`);
        
        // Refresh UI if widget is open
        if (widgetOpen && currentMode === 'tryon') {
            await populateFeaturedAndQuickPicks();
        }
        
    } catch (error) {
        console.error('❌ Error loading from Shopify:', error);
        
        // Show user-friendly error message
        showSuccessNotification('Connection Error', 'Unable to load products. Using demo data.', 5000);
        
        // Fallback: Create some demo data so widget still works
        sampleClothing = [
            {
                id: 'demo-item-1',
                name: 'Demo Product (Shopify Connection Failed)',
                price: 29.99,
                category: 'shirt',
                color: 'blue',
                image_url: 'https://via.placeholder.com/300x400?text=Demo+Product',
                product_url: '#',
                variants: [{ id: 'demo-variant', title: 'One Size', price: 29.99, available: true }]
            }
        ];
        console.log('Using demo data due to Shopify connection error');
    }
}

// Utility function for retry logic
async function fetchWithRetry(url, options, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            return response;
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            console.log(`Retry ${i + 1}/${maxRetries} for ${url}`);
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Exponential backoff
        }
    }
}


// 🎯 ADD THIS NEW FUNCTION HERE:
function detectCurrentProduct() {
    // Method 1: Check URL for product handle (most reliable)
    const urlPath = window.location.pathname;
    const productMatch = urlPath.match(/\/products\/([^\/\?]+)/);
    
    if (productMatch) {
        const productHandle = productMatch[1];
        console.log('Detected product handle from URL:', productHandle);
        
        // Find matching product in our loaded data
        const product = sampleClothing.find(item => item.id === productHandle);
        if (product) {
            console.log('✅ Found matching product:', product);
            return product;
        }
    }
    
    // Method 2: Check Shopify analytics object
    if (window.ShopifyAnalytics && window.ShopifyAnalytics.meta && window.ShopifyAnalytics.meta.product) {
        const productId = window.ShopifyAnalytics.meta.product.id;
        const product = sampleClothing.find(item => item.shopify_product_id === productId);
        if (product) {
            console.log('✅ Found product via Shopify analytics:', product);
            return product;
        }
    }
    
    // Method 3: Look for JSON-LD structured data
    const jsonLdScripts = document.querySelectorAll('script[type="application/ld+json"]');
    for (let script of jsonLdScripts) {
        try {
            const jsonData = JSON.parse(script.textContent);
            if (jsonData['@type'] === 'Product' && jsonData.url) {
                const urlHandle = jsonData.url.split('/').pop().split('?')[0];
                const product = sampleClothing.find(item => item.id === urlHandle);
                if (product) {
                    console.log('✅ Found product via JSON-LD:', product);
                    return product;
                }
            }
        } catch (e) {
            // JSON parsing failed, continue
        }
    }
    
    // Method 4: Check for product page elements and match by title
    const productTitleSelectors = [
        '.product-title',
        '.product__title', 
        'h1.product-single__title',
        '.product-form__title',
        '.product__heading',
        '[data-product-title]'
    ];
    
    for (let selector of productTitleSelectors) {
        const titleElement = document.querySelector(selector);
        if (titleElement) {
            const title = titleElement.textContent.trim();
            const product = sampleClothing.find(item => 
                item.name.toLowerCase() === title.toLowerCase() ||
                title.toLowerCase().includes(item.name.toLowerCase()) ||
                item.name.toLowerCase().includes(title.toLowerCase())
            );
            if (product) {
                console.log('✅ Found product via title match:', product);
                return product;
            }
        }
    }
    
    console.log('❌ No current product detected');
    return null;
}

// Helper function to extract color from product data
function getColorFromProduct(product) {
    // Check product tags for colors
    const colors = ['red', 'blue', 'green', 'black', 'white', 'pink', 'yellow', 'purple', 'orange', 'brown', 'gray', 'navy', 'beige'];
    
    // Check tags first
    if (product.tags) {
        for (let tag of product.tags) {
            for (let color of colors) {
                if (tag.toLowerCase().includes(color)) {
                    return color;
                }
            }
        }
    }
    
    // Check product title
    const title = product.title.toLowerCase();
    for (let color of colors) {
        if (title.includes(color)) {
            return color;
        }
    }
    
    // Check variants for color options
    if (product.variants && product.variants[0] && product.variants[0].option2) {
        const option2 = product.variants[0].option2.toLowerCase();
        for (let color of colors) {
            if (option2.includes(color)) {
                return color;
            }
        }
    }
    
    // Default fallback
    return 'multicolor';
}

        // State
        let widgetOpen = false;
        let currentMode = 'tryon';
        let selectedClothing = null;
        let userPhoto = null;
        let userPhotoFileId = null;
        let sessionId = generateSessionId();
        let filteredClothing = [...sampleClothing];
        let userEmail = null;
        let tryonChatHistory = [];
        let generalChatHistory = [];
        let currentTryOnId = null;
        let currentFeaturedItem = null;

        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const viewport = window.innerWidth;
            
            const mobileUserAgents = /android|webos|iphone|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const ipadUserAgent = /ipad/i.test(userAgent);
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            isMobile = (mobileUserAgents && !ipadUserAgent) && isTouchDevice && viewport <= 768;
            isTablet = (ipadUserAgent || (/android/i.test(userAgent) && viewport > 768)) && isTouchDevice;
            isIOS = /iphone|ipad|ipod/i.test(userAgent);
            isAndroid = /android/i.test(userAgent);
            
            if (isMobile) {
                document.body.classList.add('is-mobile');
            } else {
                document.body.classList.remove('is-mobile');
            }
            
            const cameraControls = document.getElementById('cameraControls');
            if (cameraControls) {
                if (isMobile) {
                    cameraControls.classList.add('mobile');
                    cameraControls.style.display = 'flex';
                } else {
                    cameraControls.classList.remove('mobile');
                    cameraControls.style.display = 'none';
                }
            }
        }

        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9);
        }
        
        function generateTryOnId() {
    return 'tryon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

        function takePicture() {
            if (!isMobile) {
                alert('Camera is only available on mobile devices');
                return;
            }

            try {
                const cameraInput = document.getElementById('cameraInput');
                
                if (isIOS) {
                    const newCameraInput = document.createElement('input');
                    newCameraInput.type = 'file';
                    newCameraInput.accept = 'image/*';
                    newCameraInput.capture = 'environment';
                    newCameraInput.style.display = 'none';
                    newCameraInput.onchange = handlePhotoUpload;
                    
                    document.body.appendChild(newCameraInput);
                    
                    setTimeout(() => {
                        newCameraInput.click();
                        setTimeout(() => {
                            if (newCameraInput.parentNode) {
                                newCameraInput.parentNode.removeChild(newCameraInput);
                            }
                        }, 1000);
                    }, 100);
                } else {
                    cameraInput.value = '';
                    setTimeout(() => {
                        cameraInput.click();
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error taking picture:', error);
                alert('Unable to access camera. Please try selecting from gallery instead.');
            }
        }

        function chooseFromGallery() {
            if (!isMobile) {
                handlePhotoUploadClick();
                return;
            }

            try {
                const photoInput = document.getElementById('photoInput');
                
                if (isIOS) {
                    const newPhotoInput = document.createElement('input');
                    newPhotoInput.type = 'file';
                    newPhotoInput.accept = 'image/*';
                    newPhotoInput.style.display = 'none';
                    newPhotoInput.onchange = handlePhotoUpload;
                    
                    document.body.appendChild(newPhotoInput);
                    
                    setTimeout(() => {
                        newPhotoInput.click();
                        setTimeout(() => {
                            if (newPhotoInput.parentNode) {
                                newPhotoInput.parentNode.removeChild(newPhotoInput);
                            }
                        }, 1000);
                    }, 100);
                } else {
                    photoInput.value = '';
                    setTimeout(() => {
                        photoInput.click();
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error choosing from gallery:', error);
                alert('Unable to access photo gallery. Please try again.');
            }
        }

        function handlePhotoUploadClick() {
            if (isMobile) {
                return;
            } else {
                const photoInput = document.getElementById('photoInput');
                if (photoInput) {
                    photoInput.click();
                }
            }
        }

        function openWidget() {
            const widget = document.getElementById('virtualTryonWidget');
            
            widget.classList.remove('widget-minimized');
            widgetOpen = true;
            
            if (isMobile) {
                document.body.style.overflow = 'hidden';
            }
            
            loadChatHistory();
            if (currentMode === 'tryon') {
                populateFeaturedAndQuickPicks();
                // 🎯 ADD THESE LINES AT THE END OF YOUR EXISTING openWidget() FUNCTION:
        setTimeout(() => {
            const currentProduct = detectCurrentProduct();
            if (currentProduct) {
                selectedClothing = currentProduct.id;
                const featuredContainer = document.getElementById('featuredItem');
                featuredContainer.classList.add('selected');
                updateTryOnButton();
                console.log('🎯 Auto-selected current product:', currentProduct.name);
            }
            
            // 🎯 Focus management - focus on first interactive element
            const firstFocusableElement = widget.querySelector('button, input, select, [tabindex]:not([tabindex="-1"])');
            if (firstFocusableElement) {
                firstFocusableElement.focus();
            }
        }, 100);
            }
        }

        /**
         * Closes the widget and resets all states
         * Handles cleanup of UI elements and user data
         */
        function closeWidget() {
            const widget = document.getElementById('virtualTryonWidget');
            if (!widget) {
                console.error('Widget element not found');
                return;
            }
            
            widget.classList.add('widget-minimized');
            widgetOpen = false;
            currentMode = 'tryon';
            
            // Reset body overflow
            document.body.style.overflow = '';
            
            // Reset mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            const firstModeBtn = document.querySelector('.mode-btn');
            if (firstModeBtn) firstModeBtn.classList.add('active');
            
            // Show try-on content, hide chat
            const tryonContent = document.getElementById('tryonContent');
            const inputArea = document.querySelector('.input-area');
            const chatContainer = document.getElementById('chatContainer');
            
            if (tryonContent) tryonContent.style.display = 'block';
            if (inputArea) inputArea.classList.remove('chat-mode');
            if (chatContainer) chatContainer.style.display = 'none';
            
            // Reset user data
            selectedClothing = null;
            userPhoto = null;
            userPhotoFileId = null;
            
            // Clear photo preview
            const preview = document.getElementById('photoPreview');
            if (preview) {
                preview.style.display = 'none';
            }
            
            // Reset upload area
            resetPhotoUploadArea();
            
            // Clear clothing selections
            document.querySelectorAll('.quick-pick-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateTryOnButton();
            
            // 🎯 Focus management - return focus to page when widget closes
            const widgetToggle = document.querySelector('.widget-toggle');
            if (widgetToggle) {
                widgetToggle.focus();
            }
        }
        
        /**
         * Resets the photo upload area to its initial state
         */
        function resetPhotoUploadArea() {
            const uploadArea = document.querySelector('.photo-upload');
            if (!uploadArea) return;
            
            uploadArea.classList.remove('has-photo', 'uploading');
            
            const uploadIcon = uploadArea.querySelector('.upload-icon');
            const uploadText = uploadArea.querySelector('.upload-text:not(#changePhotoText)');
            const changeText = document.getElementById('changePhotoText');
            
            if (uploadIcon) uploadIcon.style.display = 'block';
            if (uploadText) uploadText.style.display = 'block';
            if (changeText) changeText.style.display = 'none';
        }

        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const tryonContent = document.getElementById('tryonContent');
            const inputArea = document.querySelector('.input-area');
            const chatContainer = document.getElementById('chatContainer');
            
            if (mode === 'tryon') {
                tryonContent.style.display = 'block';
                inputArea.classList.remove('chat-mode');
                chatContainer.style.display = 'none';
                populateFeaturedAndQuickPicks();
            } else {
                tryonContent.style.display = 'none';
                inputArea.classList.add('chat-mode');
                chatContainer.style.display = 'flex';
            }
            
            loadChatHistory();
        }

        // 🔄 REPLACE YOUR EXISTING populateFeaturedAndQuickPicks() FUNCTION WITH THIS:
async function populateFeaturedAndQuickPicks() {
    if (sampleClothing.length === 0) {
        await loadClothingData();
    }
    
    if (sampleClothing.length === 0) {
        return; // No items available
    }
    
    // 🎯 TRY TO DETECT CURRENT PRODUCT PAGE
    const currentProduct = detectCurrentProduct();
    let featuredItem = null;
    let quickPicksPool = [...sampleClothing];
    
    if (currentProduct) {
        // Use current product as featured item
        featuredItem = currentProduct;
        // Remove current product from quick picks pool
        quickPicksPool = sampleClothing.filter(item => item.id !== currentProduct.id);
        console.log('🎯 Using current product as featured:', featuredItem.name);
    } else {
        // Fallback to variety-based selection
        const categories = ['dress', 'shirt', 'pants', 'jacket', 'shorts'];
        const varietyItems = [];

        categories.forEach(category => {
            const categoryItem = sampleClothing.find(item => item.category === category);
            if (categoryItem) {
                varietyItems.push(categoryItem);
            }
        });

        while (varietyItems.length < 7 && varietyItems.length < sampleClothing.length) {
            const remainingItems = sampleClothing.filter(item => !varietyItems.includes(item));
            if (remainingItems.length > 0) {
                varietyItems.push(remainingItems[0]);
            } else {
                break;
            }
        }

        featuredItem = varietyItems[0];
        quickPicksPool = varietyItems.slice(1);
        console.log('📦 Using variety-based featured item:', featuredItem.name);
    }

    // Populate featured item section
    const featuredContainer = document.getElementById('featuredItem');
    const badgeText = currentProduct ? 'Current Page' : 'Trending';
    
    featuredContainer.innerHTML = `
        <div class="featured-content">
            <img src="${featuredItem.image_url}" alt="${featuredItem.name}" class="featured-image">
            <div class="featured-info">
                <div class="featured-name">${featuredItem.name}</div>
                <div class="featured-price">$${featuredItem.price.toFixed(2)}</div>
                <div class="featured-badge">${badgeText}</div>
            </div>
        </div>
    `;

    // Populate quick picks (up to 6 items)
    const quickPicks = quickPicksPool.slice(0, 6);
    const quickPicksGrid = document.getElementById('quickPicksGrid');
    
    let quickPicksHTML = '';
    quickPicks.forEach(item => {
        quickPicksHTML += `
            <div class="quick-pick-item" onclick="selectClothing('${item.id}')">
                <img src="${item.image_url}" alt="${item.name}" class="quick-pick-image">
                <div class="quick-pick-name">${item.name}</div>
                <div class="quick-pick-price">$${item.price.toFixed(2)}</div>
            </div>
        `;
    });
    
    quickPicksGrid.innerHTML = quickPicksHTML;
    currentFeaturedItem = featuredItem;
}

        function selectFeaturedClothing() {
            if (!currentFeaturedItem) return;
            selectedClothing = currentFeaturedItem.id;
            // Clear other selections
            document.querySelectorAll('.quick-pick-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Highlight featured item
            const featuredContainer = document.getElementById('featuredItem');
            featuredContainer.classList.add('selected');
            updateTryOnButton();
        }

        function selectClothing(clothingId) {
            selectedClothing = clothingId;
            
            // Clear featured selection
            const featuredContainer = document.getElementById('featuredItem');
            featuredContainer.classList.remove('selected');
            
            // Clear other quick pick selections
            document.querySelectorAll('.quick-pick-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Highlight selected item
            event.target.closest('.quick-pick-item').classList.add('selected');
            
            updateTryOnButton();
        }

        function resetSelection() {
            selectedClothing = null;
            userPhoto = null;
            userPhotoFileId = null;
            
            // Clear all selections
            document.querySelectorAll('.featured-item, .quick-pick-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Reset photo preview
            const preview = document.getElementById('photoPreview');
            const uploadArea = document.querySelector('.photo-upload');
            const changeText = document.getElementById('changePhotoText');
            const uploadIcon = uploadArea.querySelector('.upload-icon');
            const uploadText = uploadArea.querySelector('.upload-text:not(#changePhotoText)');
            
            preview.style.display = 'none';
            uploadArea.classList.remove('has-photo');
            changeText.style.display = 'none';
            
            // Show the upload elements again
            uploadIcon.style.display = 'block';
            uploadText.style.display = 'block';
            
            // Hide result section
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'none';
            
            updateTryOnButton();
        }

        function updateTryOnButton() {
            const btn = document.getElementById('tryOnBtn');
            btn.disabled = !(userPhoto && selectedClothing);
        }

        function loadChatHistory() {
            const container = document.getElementById('chatContainer');
            const history = currentMode === 'tryon' ? tryonChatHistory : generalChatHistory;
            
            if (currentMode !== 'chat') {
                return;
            }
            
            container.innerHTML = '';
            history.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${msg.type}-message`;
                messageEl.textContent = msg.content;
                container.appendChild(messageEl);
            });
            
            container.scrollTop = container.scrollHeight;
            
            if (history.length === 0 && currentMode === 'chat') {
                addBotMessage("Hi! I'm your personal fashion assistant. Ask me anything about style, trends, or fashion advice! ✨");
            }
        }

        function addMessage(content, type) {
            const container = document.getElementById('chatContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}-message`;
            messageEl.textContent = content;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            
            const history = currentMode === 'tryon' ? tryonChatHistory : generalChatHistory;
            history.push({ content, type });
        }

        function addUserMessage(content) {
            addMessage(content, 'user');
        }

        function addBotMessage(content) {
            addMessage(content, 'bot');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            if (!input) {
                console.error('Message input element not found');
                return;
            }
            
            const message = input.value.trim();
            
            // Input validation
            if (!message) {
                console.log('Empty message, ignoring send request');
                return;
            }
            
            if (message.length > 1000) {
                showSuccessNotification('Message Too Long', 'Please keep messages under 1000 characters.', 3000);
                return;
            }
            
            // Add user message and clear input
            addUserMessage(message);
            input.value = '';
            
            // Disable input during processing
            input.disabled = true;
            const sendButton = document.querySelector('.send-button');
            if (sendButton) sendButton.disabled = true;
            
            try {
                if (currentMode === 'chat') {
                    await handleChatMessage(message);
                } else {
                    // Simulate processing delay for try-on mode
                    setTimeout(() => {
                        handleTryOnMessage(message);
                        enableMessageInput();
                    }, 1000);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addBotMessage("Sorry, I'm having trouble processing your message. Please try again.");
                enableMessageInput();
            }
        }
        
        async function handleChatMessage(message) {
            try {
                const webhookData = {
                    mode: 'chat',
                    sessionId: sessionId,
                    userEmail: userEmail,
                    message: message,
                    deviceInfo: {
                        isMobile: isMobile,
                        isTablet: isTablet,
                        isIOS: isIOS,
                        isAndroid: isAndroid,
                        viewport: {
                            width: window.innerWidth,
                            height: window.innerHeight
                        }
                    },
                    timestamp: new Date().toISOString()
                };
                
                // Use retry logic for API calls
                const response = await fetchWithRetry(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(webhookData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Extract bot response with multiple fallback patterns
                const botResponse = extractBotResponse(result);
                
                if (botResponse) {
                    addBotMessage(botResponse);
                } else {
                    console.warn('No valid response format found:', result);
                    handleGeneralMessage(message);
                }
                
            } catch (error) {
                console.error('Chat webhook error:', error);
                addBotMessage("I'm having trouble connecting right now. Please try again in a moment.");
                handleGeneralMessage(message);
            } finally {
                enableMessageInput();
            }
        }
        
        function extractBotResponse(result) {
            // Try multiple response patterns
            const patterns = [
                result?.[0]?.output?.response,
                result?.output?.response,
                result?.response,
                result?.reply,
                result?.message,
                result?.text
            ];
            
            for (const response of patterns) {
                if (response && typeof response === 'string' && response.trim()) {
                    return response.trim();
                }
            }
            
            return null;
        }
        
        function enableMessageInput() {
            const input = document.getElementById('messageInput');
            const sendButton = document.querySelector('.send-button');
            
            if (input) input.disabled = false;
            if (sendButton) sendButton.disabled = false;
        }

        function handleTryOnMessage(message) {
            if (message.toLowerCase().includes('photo') || message.toLowerCase().includes('picture')) {
                if (isMobile) {
                    addBotMessage("Please use the camera buttons to take a picture or select from your gallery! 📸");
                } else {
                    addBotMessage("Please use the photo upload area to add your picture! 📸");
                }
            } else if (message.toLowerCase().includes('clothes') || message.toLowerCase().includes('outfit')) {
                addBotMessage("Great! Check out our featured item or quick picks, or browse our full collection! 👗");
            } else {
                addBotMessage("I'm here to help you try on clothes virtually! Upload a photo and pick an item to get started. ✨");
            }
        }

        function handleGeneralMessage(message) {
            const responses = [
                "That's a great question about fashion! Trends are always evolving. 💫",
                "I love helping with style choices! What's your favorite color to wear? 🎨",
                "Fashion is all about expressing yourself! What look are you going for? ✨",
                "Style tip: Confidence is your best accessory! 💪"
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addBotMessage(randomResponse);
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            // Enhanced file validation
            const validationResult = validateImageFile(file);
            if (!validationResult.isValid) {
                showSuccessNotification('Invalid File', validationResult.error, 4000, true);
                return;
            }
            
            // Show loading state
            const uploadArea = document.querySelector('.photo-upload');
            if (uploadArea) {
                uploadArea.classList.add('uploading');
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    userPhoto = e.target.result;
                    userPhotoFileId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    updatePhotoPreview(e.target.result);
                    updateTryOnButton();
                    
                    // Haptic feedback on mobile
                    if (isMobile && navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    
                    showSuccessNotification('Photo Uploaded', 'Your photo has been uploaded successfully!', 2000);
                    
                } catch (error) {
                    console.error('Error processing uploaded image:', error);
                    showSuccessNotification('Upload Error', 'Failed to process the image. Please try again.', 4000);
                } finally {
                    if (uploadArea) {
                        uploadArea.classList.remove('uploading');
                    }
                }
            };
            
            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                showSuccessNotification('File Error', 'Error reading the image file. Please try again.', 4000);
                if (uploadArea) {
                    uploadArea.classList.remove('uploading');
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        function validateImageFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            
            if (!file) {
                return { isValid: false, error: 'No file selected.' };
            }
            
            if (!allowedTypes.includes(file.type)) {
                return { 
                    isValid: false, 
                    error: 'Please select a valid image file (JPEG, PNG, WebP, or GIF).' 
                };
            }
            
            if (file.size > maxSize) {
                return { 
                    isValid: false, 
                    error: 'Image file is too large. Please choose a file smaller than 10MB.' 
                };
            }
            
            return { isValid: true };
        }
        
        function updatePhotoPreview(imageData) {
            const preview = document.getElementById('photoPreview');
            const uploadArea = document.querySelector('.photo-upload');
            const changeText = document.getElementById('changePhotoText');
            const uploadIcon = uploadArea?.querySelector('.upload-icon');
            const uploadText = uploadArea?.querySelector('.upload-text:not(#changePhotoText)');
            
            if (preview) {
                preview.src = imageData;
                preview.style.display = 'block';
            }
            
            if (uploadArea) {
                // Hide the upload elements
                if (uploadIcon) uploadIcon.style.display = 'none';
                if (uploadText) uploadText.style.display = 'none';
                
                uploadArea.classList.add('has-photo');
                uploadArea.style.display = 'block';
            }
            
            if (changeText) {
                changeText.style.display = 'block';
                changeText.textContent = isMobile ? 'Tap to change photo' : 'Click to change photo';
            }
        }

        function openClothingBrowser() {
            const modal = document.getElementById('clothingBrowserModal');
            const backdrop = document.getElementById('modalBackdrop');
            
            modal.classList.add('active');
            backdrop.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            renderBrowserGrid();
        }

        function closeClothingBrowser() {
            const modal = document.getElementById('clothingBrowserModal');
            const backdrop = document.getElementById('modalBackdrop');
            
            modal.classList.remove('active');
            backdrop.classList.remove('active');
            
            if (!widgetOpen || !isMobile) {
                document.body.style.overflow = '';
            }
        }

        function renderBrowserGrid() {
            const grid = document.getElementById('browserGrid');
            
            let gridHTML = '';
            sampleClothing.forEach(item => {
                const isSelected = selectedClothing === item.id;
                const selectedClass = isSelected ? 'selected' : '';
                
                gridHTML += `
                    <div class="browser-clothing-card ${selectedClass}" onclick="selectClothingFromBrowser('${item.id}')">
                        <img src="${item.image_url}" alt="${item.name}" loading="lazy">
                        <div class="browser-card-name">${item.name}</div>
                        <div class="browser-card-price">${item.price.toFixed(2)}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = gridHTML;
        }

        function selectClothingFromBrowser(clothingId) {
            selectedClothing = clothingId;
            
            document.querySelectorAll('.browser-clothing-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.browser-clothing-card').classList.add('selected');
            
            closeClothingBrowser();
            populateFeaturedAndQuickPicks();
            updateTryOnButton();
        }

        function handleBrowserSearch() {
            const searchTerm = document.getElementById('browserSearch').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredClothing = [...sampleClothing];
            } else {
                filteredClothing = sampleClothing.filter(item => {
                    const matchesName = item.name.toLowerCase().includes(searchTerm);
                    const matchesCategory = item.category.toLowerCase().includes(searchTerm);
                    const matchesColor = item.color.toLowerCase().includes(searchTerm);
                    
                    return matchesName || matchesCategory || matchesColor;
                });
            }
            
            updateBrowserDisplay();
        }

        function updateBrowserDisplay() {
            const grid = document.getElementById('browserGrid');
            const noResults = document.getElementById('noResultsMessage');
            const resultsCount = document.getElementById('searchResultsCount');
            
            grid.innerHTML = '';
            
            if (filteredClothing.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                resultsCount.textContent = '';
            } else {
                grid.style.display = 'grid';
                noResults.style.display = 'none';
                resultsCount.textContent = `${filteredClothing.length} item${filteredClothing.length !== 1 ? 's' : ''} found`;
                
                filteredClothing.forEach(item => {
                    const isSelected = selectedClothing === item.id;
                    const selectedClass = isSelected ? 'selected' : '';
                    
                    const cardElement = document.createElement('div');
                    cardElement.className = `browser-clothing-card ${selectedClass}`;
                    cardElement.onclick = () => selectClothingFromBrowser(item.id);
                    
                    cardElement.innerHTML = `
                        <img src="${item.image_url}" alt="${item.name}" loading="lazy">
                        <div class="browser-card-name">${item.name}</div>
                        <div class="browser-card-price">${item.price.toFixed(2)}</div>
                    `;
                    
                    grid.appendChild(cardElement);
                });
            }
        }

        // Fixed startTryOn function - always pass tryOnId as parameter
async function startTryOn() {
    if (!userPhoto || !selectedClothing) {
        alert("Please upload a photo and select clothing first!");
        return;
    }
    
    // Generate unique try-on ID for this attempt
    currentTryOnId = generateTryOnId();
    console.log('Generated tryOnId:', currentTryOnId);
    
    const resultSection = document.getElementById('resultSection');
    resultSection.innerHTML = '<div class="loading"><div class="spinner"></div>Creating your virtual try-on...</div>';
    resultSection.style.display = 'block';
            
    try {
        const clothing = sampleClothing.find(item => item.id === selectedClothing);
        
        const webhookData = {
            mode: 'tryon',
            tryOnId: currentTryOnId,
            sessionId: sessionId,
            storeId: window.ELLO_STORE_ID || 'default_store',
            userEmail: userEmail,
            userPhoto: userPhoto,
            file_id: userPhotoFileId,
            selectedClothing: {
                id: clothing.id,
                name: clothing.name,
                price: clothing.price.toFixed(2),
                category: clothing.category,
                color: clothing.color,
                image_url: clothing.image_url
            },
            deviceInfo: {
                isMobile: isMobile,
                isTablet: isTablet,
                isIOS: isIOS,
                isAndroid: isAndroid,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            },
            timestamp: new Date().toISOString()
        };
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(webhookData),
            signal: controller.signal
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.result_image_url) {
            // SUCCESS CASE - Pass tryOnId as parameter
            resultSection.innerHTML = `
                <div class="result-container">
                    <h4>Your Virtual Try-On Result</h4>
                    <img src="${result.result_image_url}" alt="Try-on result" class="result-image" onclick="openImageModal('${result.result_image_url}')">
                    <p>How do you like the ${clothing.name}?</p>
                    <div class="buy-now-container">
                        <button class="buy-now-btn" onclick="handleBuyNow('${clothing.id}', '${result.result_image_url}', '${currentTryOnId}')">
                            <div class="loading-spinner"></div>
                            <span class="btn-text">
                                <span class="cart-icon">🛒</span>
                                Buy Now - $${clothing.price.toFixed(2)}
                            </span>
                        </button>
                    </div>
                </div>
            `;
        } else {
            // FALLBACK CASE - Pass tryOnId as parameter
            const placeholderUrl = 'https://via.placeholder.com/300x400?text=Try-On+Result';
            resultSection.innerHTML = `
                <div class="result-container">
                    <h4>Your Virtual Try-On Result</h4>
                    <img src="${placeholderUrl}" alt="Try-on result" class="result-image" onclick="openImageModal('${placeholderUrl}')">
                    <p>How do you like the ${clothing.name}?</p>
                    <div class="buy-now-container">
                        <button class="buy-now-btn" onclick="handleBuyNow('${clothing.id}', '${placeholderUrl}', '${currentTryOnId}')">
                            <div class="loading-spinner"></div>
                            <span class="btn-text">
                                <span class="cart-icon">🛒</span>
                                Buy Now - $${clothing.price.toFixed(2)}
                            </span>
                        </button>
                    </div>
                    <small style="color: #64748b;">Processing completed - result may take a moment to generate</small>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Webhook error:', error);
        
        // ERROR CASE - Pass tryOnId as parameter
        const clothing = sampleClothing.find(item => item.id === selectedClothing);
        const placeholderUrl = 'https://via.placeholder.com/300x400?text=Try-On+Result';
        resultSection.innerHTML = `
            <div class="result-container">
                <h4>Virtual Try-On Result</h4>
                <img src="${placeholderUrl}" alt="Try-on result" class="result-image" onclick="openImageModal('${placeholderUrl}')">
                <p>How do you like the ${clothing.name}?</p>
                <div class="buy-now-container">
                    <button class="buy-now-btn" onclick="handleBuyNow('${clothing.id}', '${placeholderUrl}', '${currentTryOnId}')">
                        <div class="loading-spinner"></div>
                        <span class="btn-text">
                            <span class="cart-icon">🛒</span>
                            Buy Now - $${clothing.price.toFixed(2)}
                        </span>
                    </button>
                </div>
                <small style="color: #e74c3c;">Network issue - showing demo result</small>
            </div>
        `;
    }
}

// Improved Size Selector Function
function showSizeSelector(clothing) {
    return new Promise((resolve) => {
        console.log('showSizeSelector called with:', clothing);
        
        // Get unique sizes from variants - try multiple methods
        const availableSizes = [];
        
        clothing.variants.forEach(variant => {
            console.log('Processing variant:', variant);
            
            let sizeValue = null;
            
            // Method 1: Check option1 (usually size)
            if (variant.option1 && variant.option1 !== 'Default Title') {
                sizeValue = variant.option1;
            }
            // Method 2: Check size field
            else if (variant.size && variant.size !== 'Default Title') {
                sizeValue = variant.size;
            }
            // Method 3: Check variant title
            else if (variant.title && variant.title !== 'Default Title') {
                sizeValue = variant.title;
            }
            // Method 4: Extract size from title if it contains known sizes
            else if (variant.title) {
                const knownSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL'];
                const foundSize = knownSizes.find(size => 
                    variant.title.toUpperCase().includes(size)
                );
                if (foundSize) {
                    sizeValue = foundSize;
                }
            }
            
            console.log('Extracted size value:', sizeValue);
            
            if (sizeValue && variant.available && !availableSizes.some(s => s.size === sizeValue)) {
                availableSizes.push({
                    size: sizeValue,
                    variantId: variant.id,
                    price: variant.price
                });
            }
        });

        console.log('Available sizes found:', availableSizes);

        // If no sizes found, just use first available variant
        if (availableSizes.length === 0) {
            console.log('No sizes detected, using first available variant');
            const firstAvailable = clothing.variants.find(v => v.available) || clothing.variants[0];
            if (firstAvailable) {
                resolve(firstAvailable.id);
                return;
            }
        }

        // If only one size, use it directly
        if (availableSizes.length === 1) {
            console.log('Only one size available, using directly');
            resolve(availableSizes[0].variantId);
            return;
        }

        // Create popup HTML (rest of your existing popup code...)
        const popup = document.createElement('div');
        popup.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 30000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        `;

        popup.innerHTML = `
            <div style="
                background: white;
                padding: 24px;
                border-radius: 8px;
                max-width: 350px;
                width: 90%;
                box-shadow: 0 25px 80px rgba(0,0,0,0.2);
                border: 1px solid #e0e0e0;
            ">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="
                        margin: 0 0 8px 0;
                        font-size: 18px;
                        font-weight: 700;
                        color: #333;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    ">Select Size</h3>
                    <p style="
                        margin: 0;
                        color: #666;
                        font-size: 14px;
                    ">${clothing.name}</p>
                </div>
                
                <div class="size-grid" style="
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 8px;
                    margin-bottom: 20px;
                ">
                    ${availableSizes.map(sizeOption => `
                        <button class="size-btn" data-variant-id="${sizeOption.variantId}" style="
                            padding: 12px 8px;
                            border: 1px solid #e0e0e0;
                            background: #f8f8f8;
                            cursor: pointer;
                            border-radius: 6px;
                            font-weight: 600;
                            font-size: 14px;
                            color: #333;
                            transition: all 0.3s ease;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        ">
                            ${sizeOption.size}
                        </button>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button id="cancelSize" style="
                        flex: 1;
                        padding: 12px;
                        background: #f0f0f0;
                        border: 1px solid #e0e0e0;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        color: #666;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-size: 13px;
                    ">Cancel</button>
                    <button id="confirmSize" style="
                        flex: 1;
                        padding: 12px;
                        background: #333;
                        color: white;
                        border: 1px solid #333;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-size: 13px;
                        opacity: 0.5;
                    " disabled>Add to Cart</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(popup);
        
        let selectedVariantId = null;
        
        // Handle size selection
        popup.querySelectorAll('.size-btn').forEach(btn => {
            btn.onclick = () => {
                // Reset all buttons
                popup.querySelectorAll('.size-btn').forEach(b => {
                    b.style.background = '#f8f8f8';
                    b.style.color = '#333';
                    b.style.borderColor = '#e0e0e0';
                });
                
                // Highlight selected button
                btn.style.background = '#333';
                btn.style.color = 'white';
                btn.style.borderColor = '#333';
                
                selectedVariantId = btn.dataset.variantId;
                
                // Enable confirm button
                const confirmBtn = popup.querySelector('#confirmSize');
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
            };
        });
        
        // Handle confirm
        popup.querySelector('#confirmSize').onclick = () => {
            document.body.removeChild(popup);
            resolve(selectedVariantId);
        };
        
        // Handle cancel
        popup.querySelector('#cancelSize').onclick = () => {
            document.body.removeChild(popup);
            resolve(null);
        };
        
        // Handle backdrop click
        popup.onclick = (e) => {
            if (e.target === popup) {
                document.body.removeChild(popup);
                resolve(null);
            }
        };
    });
}

// Custom Notification Function
function showSuccessNotification(title, subtitle, duration = 4000, isError = false) {
    // Remove any existing notification
    const existing = document.querySelector('.custom-notification');
    if (existing) {
        existing.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'custom-notification' + (isError ? ' error' : '');
    
    notification.innerHTML = `
        <div class="notification-icon">
            ${isError ? '✗' : '✓'}
        </div>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-subtitle">${subtitle}</div>
        </div>
        <button class="notification-close" onclick="hideNotification(this.parentElement)">
            ×
        </button>
        <div class="notification-progress"></div>
    `;
    
    document.body.appendChild(notification);
    
    // Trigger show animation
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    // Auto-hide after duration
    setTimeout(() => {
        hideNotification(notification);
    }, duration);
}

function hideNotification(notification) {
    if (!notification) return;
    
    notification.classList.add('hide');
    notification.classList.remove('show');
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.parentElement.removeChild(notification);
        }
    }, 400);
}

// Function to update cart display after adding items
async function updateCartDisplay() {
    try {
        // Fetch the latest cart data
        const cartResponse = await fetch('/cart.js');
        const cartData = await cartResponse.json();
        
        console.log('Updated cart data:', cartData);
        
        // Update cart counter (try multiple common selectors)
        const cartCounters = [
            '.cart-count',
            '.cart-counter', 
            '.cart-item-count',
            '[data-cart-count]',
            '.header__cart-count',
            '.cart-link__bubble',
            '.cart__count',
            '#cart-count',
            '.cart-count-bubble'
        ];
        
        cartCounters.forEach(selector => {
            const counter = document.querySelector(selector);
            if (counter) {
                counter.textContent = cartData.item_count;
                counter.innerHTML = cartData.item_count;
                // Also try setting attributes
                counter.setAttribute('data-count', cartData.item_count);
            }
        });
        
        // Trigger cart update events that themes might listen for
        const cartUpdateEvents = [
            'cart:updated',
            'cart:refresh', 
            'cart:change',
            'cartUpdated',
            'ajaxCart:updated'
        ];
        
        cartUpdateEvents.forEach(eventName => {
            document.dispatchEvent(new CustomEvent(eventName, {
                detail: { cart: cartData }
            }));
            
            // Also try on window
            window.dispatchEvent(new CustomEvent(eventName, {
                detail: { cart: cartData }
            }));
        });
        
        // If there's a global cart object, update it
        if (window.cart) {
            window.cart = cartData;
        }
        if (window.theme && window.theme.cart) {
            window.theme.cart = cartData;
        }
        
        // Force update any cart drawers/popups
        const cartDrawers = [
            '.cart-drawer',
            '.mini-cart',
            '.cart-popup',
            '[data-cart-drawer]'
        ];
        
        cartDrawers.forEach(selector => {
            const drawer = document.querySelector(selector);
            if (drawer && drawer.classList.contains('active')) {
                // If cart drawer is open, you might want to refresh it
                // This depends on your theme's implementation
            }
        });
        
        console.log('✅ Cart display updated successfully');
        
    } catch (error) {
        console.error('❌ Error updating cart display:', error);
        // Don't throw error - the item was still added successfully
    }
}

async function handleBuyNow(clothingId, tryonResultUrl, tryOnId) {
    const buyBtn = event.target.closest('.buy-now-btn');
    const clothing = sampleClothing.find(item => item.id === clothingId);
    
    console.log('handleBuyNow called for:', clothing);
    
    if (!clothing) {
        alert('Item not found. Please try again.');
        return;
    }
    
    if (!clothing.variants || clothing.variants.length === 0) {
        alert('Product variants not found');
        return;
    }
    
    buyBtn.classList.add('loading');
    buyBtn.disabled = true;
    
    try {
        let variantToAdd = null;
        
        // If only one variant, use it directly
        if (clothing.variants.length === 1) {
            variantToAdd = clothing.variants[0];
            console.log('Single variant found, using:', variantToAdd);
        } 
        // Multiple variants - show size selector
        else {
            console.log('Multiple variants found, showing size selector...');
            
            // Reset button state
            buyBtn.classList.remove('loading');
            buyBtn.disabled = false;
            
            // Show size selector popup
            const selectedVariantId = await showSizeSelector(clothing);
            
            if (!selectedVariantId) {
                console.log('User cancelled size selection');
                return; // User cancelled
            }
            
            // Find the selected variant
            variantToAdd = clothing.variants.find(v => v.id == selectedVariantId);
            
            if (!variantToAdd) {
                alert('Selected size not found. Please try again.');
                return;
            }
            
            // Reload button state for cart addition
            buyBtn.classList.add('loading');
            buyBtn.disabled = true;
            
            console.log('User selected variant:', variantToAdd);
        }
        
        console.log('Attempting to add variant to cart:', variantToAdd);
        
        // Add to Shopify cart using the variant ID
        const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: variantToAdd.id,
                quantity: 1
            })
        });
        
        console.log('Shopify response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('✅ Successfully added to cart:', result);
            
            const sizeText = variantToAdd.size || variantToAdd.title || '';
            // Show custom notification instead of alert
const sizeDisplay = sizeText ? `Size ${sizeText}` : '';
showSuccessNotification(
    'Added to Cart!',
    `${clothing.name} ${sizeDisplay ? `• ${sizeDisplay}` : ''}`
);

// Update cart display immediately
await updateCartDisplay();

            
        } else {
            const errorText = await response.text();
            console.error('❌ Shopify cart error:', errorText);
            alert(`❌ Failed to add to cart. Error: ${response.status}`);
        }
        
    } catch (error) {
        console.error('❌ Network error:', error);
        alert('❌ Network error: ' + error.message);
    } finally {
        buyBtn.classList.remove('loading');
        buyBtn.disabled = false;
    }
}

        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal(event) {
            if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close')) {
                return;
            }
            
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            
            if (!widgetOpen || !isMobile) {
                document.body.style.overflow = '';
            } else if (isMobile && widgetOpen) {
                document.body.style.overflow = 'hidden';
            }
        }

        function handleOrientationChange() {
            if (isMobile) {
                setTimeout(() => {
                    detectDevice();
                    
                    if (widgetOpen) {
                        const widget = document.getElementById('virtualTryonWidget');
                        widget.style.display = 'none';
                        widget.offsetHeight;
                        widget.style.display = 'flex';
                    }
                }, 100);
            }
        }

        function preventZoom() {
            if (isMobile) {
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
    detectDevice();
    
    tryonChatHistory = [];
    generalChatHistory = [];
    
    // Load clothing data from Supabase
    loadClothingData();
            
            document.getElementById('virtualTryonWidget').addEventListener('click', function(e) {
                // Only open widget if it's minimized AND the click is not on the close button
                if (this.classList.contains('widget-minimized') && !e.target.closest('.widget-toggle') && !e.target.closest('.btn')) {
                    openWidget();
                }
            });
            
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', handleOrientationChange);
            
            preventZoom();
            
            if (isMobile) {
                document.addEventListener('touchstart', function() {}, { passive: true });
                
                const cameraControls = document.getElementById('cameraControls');
                if (cameraControls) {
                    cameraControls.addEventListener('touchstart', function(e) {
                        e.stopPropagation();
                    }, { passive: true });
                }
            }
        });

        /**
         * Enhanced keyboard navigation
         * - Enter key: Triggers Try On button when widget is open
         * - Escape key: Closes widget, modals, and browsers
         */
        document.addEventListener('keydown', function(event) {
            // Escape key - close widget, modals, and browsers
            if (event.key === 'Escape') {
                // Close image modal if open
                const imageModal = document.getElementById('imageModal');
                if (imageModal && imageModal.classList.contains('active')) {
                    closeImageModal(event);
                    return;
                }
                
                // Close clothing browser if open
                const clothingBrowser = document.getElementById('clothingBrowserModal');
                if (clothingBrowser && clothingBrowser.classList.contains('active')) {
                    closeClothingBrowser();
                    return;
                }
                
                // Close main widget if open
                if (widgetOpen) {
                    closeWidget();
                    return;
                }
            }
            
            // Enter key - trigger Try On button when widget is open (but not when typing in message input)
            if (event.key === 'Enter' && widgetOpen) {
                const activeElement = document.activeElement;
                const messageInput = document.getElementById('messageInput');
                const tryOnBtn = document.getElementById('tryOnBtn');
                
                // Don't trigger Try On if user is typing in message input
                if (activeElement === messageInput) {
                    return; // Let the message input handle Enter key
                }
                // Only trigger if Try On button is enabled
                if (tryOnBtn && !tryOnBtn.disabled) {
                    event.preventDefault();
                    startTryOn();
                } else {
                    // Prevent Enter from doing anything else if Try On is disabled
                    event.preventDefault();
                    return;
                }
            }
        });

        if (isMobile) {
            window.addEventListener('popstate', function(event) {
                if (widgetOpen) {
                    closeWidget();
                    event.preventDefault();
                }
            });
        }
    </script>
</body>
</html>
